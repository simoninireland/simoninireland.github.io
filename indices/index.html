<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simon Dobson</title>
<style>
	@font-face {
	    font-family: "libretto-icons";
	    src:url(../assets/fonts/libretto-icons.eot);
	    src:url(../assets/fonts/libretto-icons.eot#iefix) format("embedded-opentype"),
	    url(../assets/fonts/libretto-icons.woff) format("woff"),
	    url(../assets/fonts/libretto-icons.ttf) format("truetype"),
	    url(../assets/fonts/libretto-icons.svg#libretto-icons) format("svg");
	    font-weight: normal;
	    font-style: normal;
	}
    </style>
<link rel="icon" href="../images/favicon.png" sizes="16x16">
<link rel="alternate" type="application/rss+xml" href="../rss.xml">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Sans+Mono|Libre+Baskerville|Montserrat|Playfair+Display|Tangerine">
<link rel="stylesheet" href="../assets/css/libretto_styles.css">
<link rel="stylesheet" href="../assets/css/baguetteBox.min.css">
<link rel="stylesheet" href="../assets/css/code.css">
<link rel="stylesheet" href="../assets/css/nikola_rst.css">
<link rel="stylesheet" href="../assets/css/nikola_ipython.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
</head>
<body>
    <!-- Navigation bar -->
    <header class="nav-bar"><div class="site-branding">
	    <h1 class="site-title">
		<a href="https://simondobson.org/" title="Simon Dobson" rel="home">Simon&nbsp;Dobson</a>
	    </h1>
	</div>
	<nav class="site-navigation" role="navigation"><div class="menu-toggle">
		<span class="mobile-site-title">Simon Dobson</span>
	    </div>
	    <ul class="menu">
<li><a href="../index.html">Home</a></li>
		    <li><a href="../personal/">About&nbsp;me</a></li>
		    <li><a href="../research/">Research</a></li>
		    <li><a href="../development/projects/">Software</a></li>
		    <li><a href="../writing/">Writing</a></li>
		    <li><a href="../personal/contact/">Contact</a></li>
		<li>
<a href="../rss.xml"><i class="fa fa-rss"></i></a>
	    </li>
</ul></nav></header><div class="site-content">
	    <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
		    <div class="entry-meta">
			<span class="posted-on">
			    Posted on <a href="../goodreads/build-an-unorthodox-guide-to-making-things-worth-making/" rel="bookmark">Saturday 3 August, 2024</a>
			</span>
		    </div>
		    <h1><a href="../goodreads/build-an-unorthodox-guide-to-making-things-worth-making/">Build: An Unorthodox Guide to Making Things Worth&nbsp;Making</a></h1>
		</div>
		<div class="entry-content">
			<div>
    <div>
      <img src="https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1652120231l/59696349._SX98_.jpg" style="float: left; margin-right: 10px"><h2>
	Tony&nbsp;Fadell
      </h2>
    </div>
    <p>
      Twenty-five years ago, more or less, I ran a start-up company. I wish books like this had existed back then to help me understand what start-ups need to do.<br><br>Fadell has perhaps the best pedigree imaginable, including being involved both in massive successes (the iPod, the iPhone, the Nest thermostat) and crashing failures (General Magic), and the best thing about this book is his willingness to share them, warts and all. He&#8217;s clearly come to a place in his life where he regards everything as a learning opportunity and a teaching opportunity, rather than needing to project a particular image of himself.<br><br>The business advice is fascinating, even for someone who doesn&#8217;t intend to start a company: there&#8217;s plenty to learn about organisation structures and politics. I suspect it&#8217;d be absolute gold for anyone thinking of making hardware devices for the modern software-dominated world, though. Fadell has a clear understanding of what&#8217;s needed to make a physical product succeed, and his emphases on story-telling and understanding the customer&#8217;s journey as a route to success are compelling. <br><br>There&#8217;s also a lot of insight into some of the major companies and personalities he&#8217;s met along the way. He&#8217;s positive about Apple, clear-eyed about Steve Jobs&#8217; strengths and weaknesses – and clearly quite shell-shocked by his exposure to Google as not what he was expecting them to&nbsp;be.
      </p>
<p>
	5/5.
	  Finished Saturday 3 August,&nbsp;2024.
	</p>
<p>
	  (Originally published on <a href="https://www.goodreads.com/review/show/6567722144?utm_medium=api&amp;utm_source=rss">Goodreads</a>.)
  </p>
</div>
		</div>
	    </article>
</div>
	<div class="site-content">
	    <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
		    <div class="entry-meta">
			<span class="posted-on">
			    Posted on <a href="../goodreads/ss-gb/" rel="bookmark">Saturday 3 August, 2024</a>
			</span>
		    </div>
		    <h1><a href="../goodreads/ss-gb/"><span class="caps">SS</span>-<span class="caps">GB</span></a></h1>
		</div>
		<div class="entry-content">
			<div>
    <div>
      <img src="https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1689536758l/63326204._SX98_.jpg" style="float: left; margin-right: 10px"><h2>
	Len Deighton&nbsp;(1979)
      </h2>
    </div>
    <p>
      An alternative history that has aged well. The premise is quite common: what if Nazi Germany had invaded Britain in the Spring of 1941, and succeeded? The plot revolves around rescuing the King and retrieving atomic secrets, both to be sent to America.<br><br>But it&#8217;s the politics of a Nazi occupation that clearly most fascinated Deighton, because he build a labyrinth of plots and counter-plots between Army, <span class="caps">SS</span>, British Resistance, and American isolationism. These internecine struggles are actually quite familiar from the actual history of Nazi occupations, so it&#8217;s quite fascinating to see them transplanted to a fictional Britain. It&#8217;s so well done that it&#8217;s a shame it isn&#8217;t part of a series (of which Deighton wrote&nbsp;several).
      </p>
<p>
	4/5.
	  Finished Saturday 3 August,&nbsp;2024.
	</p>
<p>
	  (Originally published on <a href="https://www.goodreads.com/review/show/6432286432?utm_medium=api&amp;utm_source=rss">Goodreads</a>.)
  </p>
</div>
		</div>
	    </article>
</div>
	<div class="site-content">
	    <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
		    <div class="entry-meta">
			<span class="posted-on">
			    Posted on <a href="../2024/08/02/metacircular-semantics-for-common-lisp-special-forms/" rel="bookmark">Friday 2 August, 2024</a>
			</span>
		    </div>
		    <h1><a href="../2024/08/02/metacircular-semantics-for-common-lisp-special-forms/">Metacircular Semantics for Common Lisp Special&nbsp;Forms</a></h1>
		</div>
		<div class="entry-content">
			<div id="outline-container-org003e69b" class="outline-2">
<h2 id="org003e69b">Metacircular Semantics for Common Lisp Special&nbsp;Forms</h2>
<div class="outline-text-2" id="text-org003e69b">
<p>
Henry G. Baker. <i><a href="https://doi.org/10.1145/382126.382662">Metacircular Semantics for Common Lisp Special Forms</a></i>.
<span class="caps">ACM</span> <span class="caps">SIGPLAN</span> Lisp Pointers <b>V</b>, pp.11–20.&nbsp;1992.
</p>

<p>
A response to the criticisms of McCarthy&#8217;s semantics for Common
Lisp that it didn&#8217;t specify the behaviours of special forms, and
of the standardisation process of adopting prose definitions that
are too &#8220;lawyerly&#8221; for&nbsp;engineering.
</p>

<p>
The approach is to define the special forms in terms of other
constructions, for&nbsp;example <code>if</code> in terms of nested lambda
abstractions to prevent execution of the unwanted branch. This is
both useful for understanding and a way of minimising the number
of under-defined special&nbsp;forms.
</p>

<p>
It suggests&nbsp;treating <code>catch</code> / <code>throw</code> as basic, both because other
control-transfer forms can be expressed sing them and because it
emphasises the interactions that preclude Common Lisp having
continuations like Scheme&#8217;s. However there&#8217;s also an argument
pursued that some other structures&nbsp;(like <code>values</code>) provide extra
information that can be useful for compilers looking to optimise.
It&#8217;s a deep exploration of the underpinnings of the language from
both theoretical and practical&nbsp;perspectives.
</p>
</div>
</div>
		</div>
	    </article>
</div>
	<div class="site-content">
	    <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
		    <div class="entry-meta">
			<span class="posted-on">
			    Posted on <a href="../2024/08/02/casting-spels-in-lisp/" rel="bookmark">Friday 2 August, 2024</a>
			</span>
		    </div>
		    <h1><a href="../2024/08/02/casting-spels-in-lisp/">Casting SPELs in&nbsp;Lisp</a></h1>
		</div>
		<div class="entry-content">
			<div id="outline-container-org8bdeee5" class="outline-2">
<h2 id="org8bdeee5">Casting SPELs in&nbsp;Lisp</h2>
<div class="outline-text-2" id="text-org8bdeee5">
<p>
<a href="https://www.lisperati.com/casting.html">https://www.lisperati.com/casting.html</a>
</p>

<p>
A tongue-in-cheek – but still excellent – comicbook-style
introduction to Lisp programming. (There&#8217;s also a version
<a href="https://www.lisperati.com/casting-spels-emacs/html/casting-spels-emacs-1.html">specifically for Emacs Lisp</a>.) It&#8217;s structured around building an
adventure-style game, which as well as being a classic also offers
lots of opportunities for exploring different data structures and
algorithms: one can easily imagine expanding it to include (for
example) an <span class="caps">AI</span> second player or autonomous non-player characters
and gradually building a really complicated application from a
standing&nbsp;start.
</p>
</div>
</div>
		</div>
	    </article>
</div>
	<div class="site-content">
	    <article class="format-standard libretto-long-form"><div class="title-block post-format-icon-pin">
		    <div class="entry-meta">
			<span class="posted-on">
			    Posted on <a href="../2024/07/27/my-mental-model-of-setf-was-wrong/" rel="bookmark">Saturday 27 July, 2024</a>
			</span>
		    </div>
		    <h1><a href="../2024/07/27/my-mental-model-of-setf-was-wrong/">My mental model of setf was&nbsp;wrong</a></h1>
		</div>
		<div class="entry-content">
			<div id="outline-container-org304e782" class="outline-2">
<h2 id="org304e782">My mental model of setf was&nbsp;wrong</h2>
<div class="outline-text-2" id="text-org304e782">
<p>
I realised recently that I&#8217;ve been thinking&nbsp;about <code>setf</code> all&nbsp;wrong.
</p>

<p>
Lisp lets programs define&nbsp;new <code>setf</code> forms for assignment. The most
common example is from <span class="caps">CLOS</span>, where a class like&nbsp;this:
</p>

<div class="highlight"><pre><span></span><span class="w">    </span><span class="p">(</span><span class="nb">defclass</span><span class="w"> </span><span class="nv">A</span><span class="w"> </span><span class="p">()</span>
<span class="w">      </span><span class="p">((</span><span class="nv">var</span>
<span class="w">        </span><span class="ss">:accessor</span><span class="w"> </span><span class="nv">a-var</span><span class="p">)))</span>
</pre></div>

<p>
will give rise to a class and two&nbsp;functions, <code>a-var</code> to read the
value of&nbsp;the <code>var</code> slot on an instance&nbsp;of <code>A</code>, and&nbsp;a <code>setf</code> target used&nbsp;as <code>(setf (a-var instance) 24)</code> to set&nbsp;the <code>var</code> slot&nbsp;of <code>instance</code>.
</p>

<p>
It&#8217;s natural to read that like as&nbsp;executing <code>(a-var instance)</code> to
retrieve a location,&nbsp;and <code>setf</code> using this location to assign to.
The documentation reinforces this view, talking about
&#8220;generalised places&#8221; as the targets&nbsp;for <code>setf</code> to store things. My
mental model was strengthened by idioms&nbsp;like <code>(setf (car pair) 23)</code>
to set the car of a pair or list,&nbsp;and <code>(setf (cdr pair) '(1 2 3)</code>
to set the cdr. The first argument is a <i>locator</i> expression
returning the place to update, and the second argument is the <i>new
value</i> to put&nbsp;there.
</p>

<p>
Natural. But&nbsp;wrong.
</p>

<hr>
<p>
The thing I missed is&nbsp;that <code>setf</code> is a <i>macro</i>: it can access the
<i>structure</i> of its arguments but not their <i>values</i>. You can&#8217;t write
code like&nbsp;this:
</p>

<div class="highlight"><pre><span></span><span class="w">     </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">l</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="nv">h</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">l</span><span class="p">)))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">h</span><span class="w"> </span><span class="mi">23</span><span class="p">))</span>
</pre></div>

<p>
and expect&nbsp;the <code>car</code> of <code>l</code> to be updated, which would make sense&nbsp;if
<code>setf</code> were working on a location,&nbsp;because <code>h</code> would be that
location. But it&nbsp;isn&#8217;t.
</p>

<p>
What actually happens is that&nbsp;the <code>setf</code> macro looks, at compile
time, at the structure of its first (locator) argument, and uses
that to dispatch to a method. Using the slot accessor above,&nbsp;the
<code>setf</code> form expands to something&nbsp;like:
</p>

<div class="highlight"><pre><span></span><span class="w">     </span><span class="p">(</span><span class="nb">defmethod</span><span class="w"> </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">a-var</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nv">a</span><span class="w"> </span><span class="nv">A</span><span class="p">))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">slot-value</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="ss">'a-var</span><span class="p">)</span><span class="w"> </span><span class="nv">a</span><span class="p">))</span>
</pre></div>

<p>
This is a method with two pieces of selection: specialised on the
type of an argument&nbsp;(<code>A</code>), and named with the <i>selector</i> used to
within the locator&nbsp;(<code>a-var</code>). It&#8217;s definition expands to <i>another</i>
<code>setf</code>, this time specialised&nbsp;against <code>slot-value</code> and an instance&nbsp;of
<code>standard-object</code>. Specialising on the selector explains why we
need that selector to be present syntactically at compile&nbsp;time.
</p>

<p>
My mistake was thinking that the similarity between access form&nbsp;and <code>setf</code> form was necessary and functional – and it isn&#8217;t
either. This has some interesting&nbsp;consequences.
</p>
</div>
<div id="outline-container-org598a20d" class="outline-3">
<h3 id="org598a20d">The selector is entirely&nbsp;arbitrary</h3>
<div class="outline-text-3" id="text-org598a20d">
<p>
If we don&#8217;t like&nbsp;using <code>car</code> to indicate the head of a list – and
some people don&#8217;t – we could in principle define a new
specialisation such&nbsp;as:
</p>

<div class="highlight"><pre><span></span><span class="w">     </span><span class="p">(</span><span class="nb">defmethod</span><span class="w"> </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">head</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nv">l</span><span class="w"> </span><span class="nb">list</span><span class="p">))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">rplaca</span><span class="w"> </span><span class="nv">l</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span>
</pre></div>

<p>
and use it&nbsp;as <code>(setf (head l) 45)</code> <i>even&nbsp;though <code>head</code> isn&#8217;t a
defined function</i>. All we need is a selector&nbsp;symbol.
</p>
</div>
</div>
<div id="outline-container-orgd341b0f" class="outline-3">
<h3 id="orgd341b0f">There can be more&nbsp;arguments</h3>
<div class="outline-text-3" id="text-orgd341b0f">
<p>
Ever since I first encountered them I wondered why the lambda
lists for&nbsp;new <code>setf</code> specialisations was so strange: the new value
and <i>then</i> the arguments – but not the selector – of the place to
be updated? Once you get a better mental model, the reason
becomes obvious: there can be <i>multiple</i> arguments to&nbsp;the <code>setf</code>
locator, possibly actually a variable number, alongside the
selector, so we need to be able to find the new value reliably.
The easiest way is to put it at the front of the lambda&nbsp;list.
</p>

<p>
There&#8217;s actually a common example of this sitting in plain sight
that I&#8217;d missed. You access the elements of a Lisp array using&nbsp;the <code>aref</code> function, which takes the array and the index, such as&nbsp;(<code>aref a 23)</code>. The&nbsp;corresponding <code>setf</code> form looks&nbsp;like <code>(setf (aref
     a 23) 0)</code>, with the locator taking several arguments like the
function. <i>But it isn&#8217;t calling the function</i>: it&#8217;s decomposing a
pattern that <i>looks exactly like</i> the function call for
convenience, and which passes several arguments to the
specialised method that will look something&nbsp;like:
</p>

<div class="highlight"><pre><span></span><span class="w">     </span><span class="p">(</span><span class="nb">defmethod</span><span class="w"> </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nb">aref</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">v</span><span class="w"> </span><span class="p">(</span><span class="nv">a</span><span class="w"> </span><span class="nc">array</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">i</span><span class="w"> </span><span class="nc">integer</span><span class="p">))</span>
<span class="w">       </span><span class="o">...</span><span class="p">)</span>
</pre></div>

<p>
The new value is reliably in the first argument position, with
the rest of the locator arguments after&nbsp;it.
</p>
</div>
</div>
<div id="outline-container-orgd7988ba" class="outline-3">
<h3 id="orgd7988ba">You can specialise by value&nbsp;too</h3>
<div class="outline-text-3" id="text-orgd7988ba">
<p>
Since&nbsp;the <code>setf</code> forms are just methods, you could if you wanted to
specialise them on the type of the new value as well as on the
locator. As a trivial&nbsp;example:
</p>

<div class="highlight"><pre><span></span><span class="w">     </span><span class="p">(</span><span class="nb">defmethod</span><span class="w"> </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">assign-head</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="nv">v</span><span class="w"> </span><span class="nc">integer</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">l</span><span class="w"> </span><span class="nb">list</span><span class="p">))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="s">"Assigned an integer ~s"</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">l</span><span class="p">)</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span>

<span class="w">     </span><span class="p">(</span><span class="nb">defmethod</span><span class="w"> </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="nv">assign-head</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="nv">s</span><span class="w"> </span><span class="nb">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">l</span><span class="w"> </span><span class="nb">list</span><span class="p">))</span>
<span class="w">       </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="s">"Assigned a string ~s"</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">l</span><span class="p">)</span><span class="w"> </span><span class="nv">s</span><span class="p">))</span>

<span class="w">     </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nv">assign-head</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span><span class="w"> </span><span class="s">"zero"</span><span class="p">)</span>
</pre></div>

<pre class="example">
Assigned a string "zero"
</pre>


<p>
Obviously there are better ways to do this, but it&#8217;s a good
example of the flexibility that comes&nbsp;from <code>setf</code> not really being
all that special a form at all: just a creative use of the power
of generic&nbsp;functions.
</p>
</div>
</div>
<div id="outline-container-orgb382c77" class="outline-3">
<h3 id="orgb382c77">Can we build our&nbsp;own <code>setf</code>-like&nbsp;macros?</h3>
<div class="outline-text-3" id="text-orgb382c77">
<p>
Yes: <code>setf</code> is entirely constructable within &#8220;ordinary&#8221;&nbsp;Lisp.
</p>

<p>
There are two parts to the construction. Firstly, we need the
name of the method that underlies a particular&nbsp;selector.
</p>

<p>
We can build our own functions with names like this, although not&nbsp;using <code>defun</code>.
</p>

<div class="highlight"><pre><span></span><span class="w">     </span><span class="p">(</span><span class="nb">defvar</span><span class="w"> </span><span class="vg">*weird-name*</span><span class="w"> </span><span class="p">(</span><span class="nb">make-symbol</span><span class="w"> </span><span class="s">"(1 2 3)"</span><span class="p">))</span>

<span class="w">     </span><span class="p">(</span><span class="nb">setf</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-function</span><span class="w"> </span><span class="vg">*weird-name*</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">a</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nb">print</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="s">"We did *weird-name* on ~s"</span><span class="w"> </span><span class="nv">a</span><span class="p">))))</span>

<span class="w">     </span><span class="p">(</span><span class="nb">funcall</span><span class="w"> </span><span class="vg">*weird-name*</span><span class="w"> </span><span class="s">"a string"</span><span class="p">)</span>
</pre></div>

<pre class="example">

"We did *weird-name* on \"a string\""
</pre>


<p>
For <code>setf</code>, the style of name used for the methods implementing the
different choices&nbsp;is <code>(setf selector)</code> – a function named by a
list – where <i>selector</i> is the symbol at the head of locator list.
(Some Lisps construct a symbol from the list elements, rather
than using it directly. I&#8217;m not sure what, if anything, the
Common Lisp language definition says about how this should&nbsp;work.)
</p>

<p>
For the second part of the&nbsp;construction, <code>setf</code> takes the locator,
synthesises the function name symbol using the selector, and
calls a generic function with this name, passing the new value
and the rest of the locator as&nbsp;arguments.
</p>

<p>
So to define a new&nbsp;construct <code>our-setf</code> we might do something&nbsp;like:
</p>

<div class="highlight"><pre><span></span><span class="w">     </span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">our-setf</span><span class="w"> </span><span class="p">(</span><span class="nv">locator</span><span class="w"> </span><span class="nv">new-value</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">selector</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">locator</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nv">our-setf-function-name</span><span class="w"> </span><span class="p">(</span><span class="nb">make-symbol</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="s">"(our-setf ~a)"</span>
<span class="w">                                                           </span><span class="nv">selector</span><span class="p">))))</span>
<span class="w">         </span><span class="o">`</span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="p">(</span><span class="nb">symbol-function</span><span class="w"> </span><span class="o">,</span><span class="nv">our-setf-function-name</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="o">,</span><span class="nv">new-value</span><span class="w"> </span><span class="o">,@</span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">locator</span><span class="p">)))))</span>
</pre></div>

<p>
When called as something&nbsp;like <code>(our-setf (head '(1 2 3)) 0)</code> the
macro will code to call a&nbsp;method <code>(our-setf head)</code> (as a symbol),
passing it&nbsp;(<code>0 '(1 2 3))</code> as arguments and allowing the machinery of
generic functions to determine which method is actually called.
We define these methods of the&nbsp;form <code>(our-setf head)</code> and specialise
them as&nbsp;required.
</p>

<p>
(It&#8217;s actually a bit more complicated than this because we need
to define a generic function&nbsp;for <code>(our-setf head)</code>. We have to go
backstage and programmatically define the generic function. But
the idea remains the&nbsp;same.)
</p>

<hr>
<p>
After all this, my mental model&nbsp;of <code>setf</code> is a lot clearer – and,
I hope, closer the reality at least. It combines a highly
structured use of macros, synthesised function names, and generic
functions – and no special machinery at&nbsp;all.
</p>

<p>
However, there&#8217;s some subtlety at play too, not obvious at first
acquaintance. We don&#8217;t want our synthesised function names to
accidentally capture the names of user-supplied code. It&#8217;s
possible that using a naming style&nbsp;like <code>setf-car</code> would do just
this, and a program happens to define a function with this name.
But the&nbsp;names <code>setf</code> synthesises are <i>lists</i>, unlikely to be captured
accidentally, which lets us define the specialised methods &#8220;as
normal&#8221; even though some of the other parts of the process have
to happen&nbsp;backstage.
</p>

<p>
This shows the power of macros and generic functions. It also
shows how deeply the latter are embedded into Lisp. They&#8217;re
usually thought of as part of <span class="caps">CLOS</span>, but they actually have little
explicit relationship to class and objects at all, and have been
woven all through Lisp to build flexible code&nbsp;structures.
</p>

<p>
<span class="caps">UPDATED</span> 2023-07-30: I incorrectly said originally that one
couldn&#8217;t use forms&nbsp;like <code>(defun (setf abc) ...)</code>: you can, just as&nbsp;with <code>defmethod</code> and <code>defgeneric</code>, and name a function using a list.
Thanks to Hacker News contributor <a href="https://phoe.github.io">phoe-krk</a> for correcting me. I
was also slightly loose in my use of <i>specialisation</i>, which I&#8217;ve
tightened&nbsp;up.
</p>
</div>
</div>
</div>
		</div>
	    </article>
</div>
    <!-- Lower Navigation links -->
    <nav class="site-content navigation-post" role="navigation"><div class="previous">
		<a href="index-149.html" rel="prev">
		    <span class="meta-nav">Older Entries</span>		</a>
	    </div>
    </nav><!-- Page Footer --><section class="footer-sidebar clear" role="complementary"><div class="widget-block">
	    <aside class="widget"><h2 class="widget-title">Simon&nbsp;Dobson</h2>
		<div class="widget-text">Aut tace aut loquere meliora silentio</div>
	    </aside>
</div>
    </section><!-- Extra JavaScript --><!-- Site Attributions --><footer class="site-footer" role="contentinfo"><div class="site-info">
	    <p></p>
	    <p>
	      Built with free and open-source software.
	      Powered by <a href="https://getnikola.com/">Nikola</a> using a theme based on
	      <a href="https://themes.getnikola.com/v7/libretto/">Libretto</a>.
	    </p>
	    <p>
	      All content Copyright © 2010–2024 Simon Dobson and licensed under
	      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="caps">CC</span>-<span class="caps">BY</span>-<span class="caps">NC</span>-<span class="caps">SA</span>-4.0</a>
	      unless otherwise&nbsp;noted.
	    </p>
	</div>
	<div class="social">
	    <ul class="menu"></ul>
</div>
    </footer>
</body>
</html>